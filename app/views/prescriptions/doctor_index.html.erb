<h1>Prescriptions Management</h1>

<!-- Patient Lookup -->
<h2>Select a Patient</h2>
<form method="get" action="<%= doctor_prescriptions_path %>">
  <label for="patient_id">Patient</label>
  <select name="patient_id" id="patient_id">
    <option value="">-- Select Patient --</option>
    <% @patients.each do |patient| %>
      <option value="<%= patient.id %>" <%= 'selected' if @selected_patient&.id == patient.id %>>
        <%= patient.username %> (<%= patient.email %>)
      </option>
    <% end %>
  </select>
  <input type="submit" value="Manage Prescriptions">
</form>

<% if @selected_patient %>
  <hr>

  <!-- View Patient's Prescriptions -->
  <h2>Prescriptions for <%= @selected_patient.username %></h2>
  <% if @prescriptions.empty? %>
    <p>This patient has no prescriptions.</p>
  <% else %>
    <table class="table table-striped table-bordered align-middle border border-dark-subtle">
      <thead>
        <tr>
          <th>Medication</th>
          <th>Dosage</th>
          <th>Instructions</th>
          <th>Prescribed By</th>
          <th>Issued On</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% @prescriptions.each do |prescription| %>
          <tr>
            <td><%= prescription.medication_name %></td>
            <td><%= prescription.dosage %></td>
            <td><%= prescription.instructions %></td>
            <td><%= prescription.doctor&.username %></td>
            <td><%= prescription.issued_on.strftime('%Y-%m-%d') %></td>
            <td style="width:210px">
              <%= form_with url: prescription_path(prescription.id), method: :patch, local: true do |f| %>
                <select name="status">
                  <option <%= 'selected' if prescription.status == "active" %>>active</option>
                  <option <%= 'selected' if prescription.status == "expired" %>>expired</option>
                  <option <%= 'selected' if prescription.status == "cancelled" %>>cancelled</option>
                </select>
                <input type="submit" value="Update">
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <hr>

  <!-- Create New Prescription Form -->
  <h2>Create New Prescription for <%= @selected_patient.username %></h2>
  <%= form_with url: prescriptions_path, method: :post, local: true do |f| %>
    <input type="hidden" name="prescription[patient_id]" value="<%= @selected_patient.id %>">
    <input type="hidden" name="prescription[status]" value="active">

    <table class="table" style="width:450px">
      <tr>
        <td><label for="prescription_medication_name">Medication Name *</label></td>
        <td><input type="text" name="prescription[medication_name]" id="prescription_medication_name" required></td>
      </tr>
      <tr>
        <td><label for="prescription_dosage">Dosage</label></td>
        <td><input type="text" name="prescription[dosage]" id="prescription_dosage"></td>
      </tr>
      <tr>
        <td><label for="prescription_instructions">Instructions</label></td>
        <td><textarea name="prescription[instructions]" id="prescription_instructions"></textarea></td>
      </tr>
    </table>

    <input type="submit" value="Create Prescription">
  <% end %>
<% end %>

