<h1>Prescriptions Management</h1>

<% if flash[:notice] %>
  <p style="color: green;"><%= flash[:notice] %></p>
<% end %>
<% if flash[:alert] %>
  <p style="color: red;"><%= flash[:alert] %></p>
<% end %>

<!-- Patient Lookup -->
<h2>Select a Patient</h2>
<form method="get" action="<%= doctor_prescriptions_path %>">
  <label for="patient_id">Patient</label>
  <select name="patient_id" id="patient_id">
    <option value="">-- Select Patient --</option>
    <% @patients.each do |patient| %>
      <option value="<%= patient.id %>" <%= 'selected' if @selected_patient&.id == patient.id %>>
        <%= patient.username %> (<%= patient.email %>)
      </option>
    <% end %>
  </select>
  <button type="submit">View Prescriptions</button>
</form>

<% if @selected_patient %>
  <hr>

  <!-- View Patient's Prescriptions -->
  <h2>Prescriptions for <%= @selected_patient.username %></h2>
  <% if @prescriptions.empty? %>
    <p>This patient has no prescriptions.</p>
  <% else %>
    <table>
      <thead>
        <tr>
          <th>Medication</th>
          <th>Dosage</th>
          <th>Instructions</th>
          <th>Prescribed By</th>
          <th>Issued On</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% @prescriptions.each do |prescription| %>
          <tr>
            <td><%= prescription.medication_name %></td>
            <td><%= prescription.dosage %></td>
            <td><%= prescription.instructions %></td>
            <td><%= prescription.doctor&.username %></td>
            <td><%= prescription.issued_on.strftime('%Y-%m-%d') %></td>
            <td><%= prescription.status %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <hr>

  <!-- Create New Prescription Form -->
  <h2>Create New Prescription for <%= @selected_patient.username %></h2>
  <%= form_with url: create_prescription_path, method: :post, local: true do |f| %>
    <input type="hidden" name="prescription[patient_id]" value="<%= @selected_patient.id %>">

    <div>
      <label for="prescription_medication_name">Medication Name *</label>
      <input type="text" name="prescription[medication_name]" id="prescription_medication_name" required>
    </div>

    <div>
      <label for="prescription_dosage">Dosage</label>
      <input type="text" name="prescription[dosage]" id="prescription_dosage">
    </div>

    <div>
      <label for="prescription_instructions">Instructions</label>
      <textarea name="prescription[instructions]" id="prescription_instructions"></textarea>
    </div>

    <div>
      <label for="prescription_status">Status</label>
      <select name="prescription[status]" id="prescription_status">
        <option value="active" selected>active</option>
        <option value="expired">expired</option>
        <option value="cancelled">cancelled</option>
      </select>
    </div>

    <button type="submit">Create Prescription</button>
  <% end %>
<% end %>

